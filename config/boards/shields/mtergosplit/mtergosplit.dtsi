#include <physical_layouts.dtsi>
#include <dt-bindings/zmk/matrix_transform.h>

/ {
    chosen {
        zmk,physical-layout = &layout;
    };

    kscan: kscan {
        compatible = "zmk,kscan-gpio-matrix";
        diode-direction = "col2row";

        row-gpios = <&pro_micro 5 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
                    <&pro_micro 6 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
                    <&pro_micro 7 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
                    <&pro_micro 8 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
                    <&pro_micro 9 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
    };

    left_encoder: encoder_left {
        compatible = "alps,ec11";
        steps = <24>;
        a-gpios = <&pro_micro 0 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        b-gpios = <&pro_micro 4 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        status = "disabled";
    };

    right_encoder: encoder_right {
        compatible = "alps,ec11";
        steps = <24>;
        a-gpios = <&pro_micro 0 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        b-gpios = <&pro_micro 4 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        status = "disabled";
    };

    sensors: sensors {
        compatible = "zmk,keymap-sensors";
        sensors = <&left_encoder &right_encoder>;
        triggers-per-rotation = <48>;
    };


    transform: matrix_transform {
        compatible = "zmk,matrix-transform";
        rows = <5>;
        columns = <15>;

        map = <
                RC(0, 0) RC(0, 1) RC(0, 2) RC(0, 3) RC(0, 4) RC(0, 5) RC(0, 6) RC(0, 7) RC(0, 8) RC(0, 9) RC(0, 10) RC(0, 11) RC(0, 12) RC(0, 13) RC(0, 14)
                RC(1, 0) RC(1, 1) RC(1, 2) RC(1, 3) RC(1, 4) RC(1, 5) RC(1, 6) RC(1, 7) RC(1, 8) RC(1, 9) RC(1, 10) RC(1, 11) RC(1, 12) RC(1, 13) RC(1, 14)
                RC(2, 0) RC(2, 1) RC(2, 2) RC(2, 3) RC(2, 4) RC(2, 5)          RC(2, 7) RC(2, 8) RC(2, 9) RC(2, 10) RC(2, 11) RC(2, 12) RC(2, 13) RC(2, 14) 
                RC(3, 0) RC(3, 1) RC(3, 2) RC(3, 3) RC(3, 4) RC(3, 5)          RC(3, 7) RC(3, 8) RC(3, 9) RC(3, 10) RC(3, 11) RC(3, 12) RC(3, 13)
                         RC(4, 1) RC(4, 2) RC(4, 3) RC(4, 4) RC(4, 5)                   RC(4, 8) RC(4, 9) RC(4, 10) RC(4, 11) RC(4, 12) RC(4, 13) RC(4, 14)
        >;
    };

    layout: layout {
        compatible = "zmk,physical-layout";
        display-name = "mtErgoSplit";
        transform = <&transform>;
        kscan = <&kscan>;

        keys  //                    w   h     x    y      rot    rx    ry
            = <&key_physical_attrs 100 100    0    0       0     0     0> /* esc */
            , <&key_physical_attrs 100 100  100    0       0     0     0> /* 1 */
            , <&key_physical_attrs 100 100  200    0       0     0     0> /* 2 */
            , <&key_physical_attrs 100 100  300    0       0     0     0> /* 3 */
            , <&key_physical_attrs 100 100  400    0       0     0     0> /* 4 */
            , <&key_physical_attrs 100 100  500    0       0     0     0> /* 5 */
            , <&key_physical_attrs 100 100  600    0       0     0     0> /* ~ */
            , <&key_physical_attrs 100 100  750    0       0     0     0> /* M1 */
            , <&key_physical_attrs 100 100  975    0       0     0     0> /* 6 */
            , <&key_physical_attrs 100 100 1075    0       0     0     0> /* 7 */
            , <&key_physical_attrs 100 100 1175    0       0     0     0> /* 8 */
            , <&key_physical_attrs 100 100 1275    0       0     0     0> /* 9 */
            , <&key_physical_attrs 100 100 1375    0       0     0     0> /* 0 */
            , <&key_physical_attrs 100 100 1475    0       0     0     0> /* - */
            , <&key_physical_attrs 100 100 1575    0       0     0     0> /* = */

            , <&key_physical_attrs 150 100    0  100       0     0     0> /* Tab */
            , <&key_physical_attrs 100 100  150  100       0     0     0> /* Q */
            , <&key_physical_attrs 100 100  250  100       0     0     0> /* W */
            , <&key_physical_attrs 100 100  350  100       0     0     0> /* E */
            , <&key_physical_attrs 100 100  450  100       0     0     0> /* R */
            , <&key_physical_attrs 100 100  550  100       0     0     0> /* T */
            , <&key_physical_attrs 100 100  850  100       0     0     0> /* Left encoder push */
            , <&key_physical_attrs 100 100  750  100       0     0     0> /* M2 */
            , <&key_physical_attrs 100 100 1025  100       0     0     0> /* Y */
            , <&key_physical_attrs 100 100 1125  100       0     0     0> /* U */
            , <&key_physical_attrs 100 100 1225  100       0     0     0> /* I */
            , <&key_physical_attrs 100 100 1325  100       0     0     0> /* O */
            , <&key_physical_attrs 100 100 1425  100       0     0     0> /* P */
            , <&key_physical_attrs 100 100 1525  100       0     0     0> /* Open bkt */
            , <&key_physical_attrs 100 100 1625  100       0     0     0> /* Close bkt */

            , <&key_physical_attrs 175 100    0  200       0     0     0> /* Capslock */
            , <&key_physical_attrs 100 100  175  200       0     0     0> /* A */
            , <&key_physical_attrs 100 100  275  200       0     0     0> /* S */
            , <&key_physical_attrs 100 100  375  200       0     0     0> /* D */
            , <&key_physical_attrs 100 100  475  200       0     0     0> /* F */
            , <&key_physical_attrs 100 100  575  200       0     0     0> /* G */
            , <&key_physical_attrs 100 100  750  200       0     0     0> /* M3 */      
            , <&key_physical_attrs 100 100  975  200       0     0     0> /* H */
            , <&key_physical_attrs 100 100 1150  200       0     0     0> /* J */
            , <&key_physical_attrs 100 100 1250  200       0     0     0> /* K */
            , <&key_physical_attrs 100 100 1350  200       0     0     0> /* L */
            , <&key_physical_attrs 100 100 1450  200       0     0     0> /* ; */
            , <&key_physical_attrs 100 100 1550  200       0     0     0> /* ' */
            , <&key_physical_attrs 175 100 1650  200       0     0     0> /* Return */

            , <&key_physical_attrs 200 100    0  300       0     0     0> /* Shift left */
            , <&key_physical_attrs 100 100  200  300       0     0     0> /* Z */
            , <&key_physical_attrs 100 100  300  300       0     0     0> /* X */
            , <&key_physical_attrs 100 100  400  300       0     0     0> /* C */
            , <&key_physical_attrs 100 100  500  300       0     0     0> /* V */
            , <&key_physical_attrs 100 100  600  300       0     0     0> /* B */
            , <&key_physical_attrs 100 100  750  300       0     0     0> /* M4 */
            , <&key_physical_attrs 100 100  975  300       0     0     0> /* N */
            , <&key_physical_attrs 100 100 1225  300       0     0     0> /* M */
            , <&key_physical_attrs 100 100 1325  300       0     0     0> /* , */
            , <&key_physical_attrs 100 100 1425  300       0     0     0> /* . */
            , <&key_physical_attrs 100 100 1525  300       0     0     0> /* Forward slash */
            , <&key_physical_attrs 200 100 1625  300       0     0     0> /* Right shift */

            , <&key_physical_attrs 100 100  150  435       0    50     0> /* Left ctrl */
            , <&key_physical_attrs 100 100  300  410     500     0     0> /* Left opt */
            , <&key_physical_attrs 100 100  450  375    1000     0     0> /* Left cmd */
            , <&key_physical_attrs 100 175  625  200    2000     0     0> /* Left space */
            , <&key_physical_attrs 100 175  725  200    2000     0     0> /* Raise right */
            , <&key_physical_attrs 100 175  725  775 (-2000)     0     0> /* Raise left */
            , <&key_physical_attrs 100 175  825  775 (-2000)     0     0> /* Right space */
            , <&key_physical_attrs 100 100 1075  675 (-1000)     0     0> /* Right cmd */
            , <&key_physical_attrs 100 100 1240  570  (-500)     0     0> /* Right opt */
            , <&key_physical_attrs 100 100  875  200       0     0     0> /* Right encoder push */
            , <&key_physical_attrs 100 100 1725  100       0     0     0> /* Backslash */
            , <&key_physical_attrs 150 100 1675    0       0     0     0> /* Bksp_Del */
            ;
    };
}; 